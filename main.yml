---
# vim: set ft=ansible:

################################################################################
################################################################################
############ Step 0 Setup Runtime
################################################################################
################################################################################

- import_playbook: setup_runtime.yml
  tags:
    - must
    - step0
    - setup_runtime

#################################################################################
#################################################################################
############ Step 1 Infrastructure
#################################################################################
#################################################################################
- vars:
    findme:
      - cloud_providers/{{ cloud_provider }}_infrastructure_deployment.yml
      - cloud_providers/none_infrastructure_deployment.yml

  import_playbook: "{{ lookup('first_found', findme) }}"
  tags:
    - step1
    - infra

- name: Infra Dynamic Roles
  import_playbook: hooks/infra.yml
  tags:
    - step1
    - deploy_infrastructure
    - dynamic_roles

################################################################################

- import_playbook: "export_inventory.yml"
  vars:
    agnosticd_inventory_exporter_stage: post_infra
  tags:
    - step1

##################################################################################
##################################################################################
############ Step 2 Software
##################################################################################
##################################################################################

- name: Environment '{{ env_type }}' specific software playbook
  import_playbook: "./configs/{{ env_type }}/software.yml"
  tags:
    - step2
    - software

- name: Software Dynamic Roles
  import_playbook: hooks/software.yml
  tags:
    - step2
    - software
    - dynamic_roles


- import_playbook: "export_inventory.yml"
  vars:
    agnosticd_inventory_exporter_stage: post_software
  tags:
    - step2
    - software

- import_playbook: save_output_dir.yml

- import_playbook: completion_callback.yml
